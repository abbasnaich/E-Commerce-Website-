{% extends "base.html" %}

{% block content %}
<div class="cart-page">
    <h1>Shopping Cart</h1>
    <div id="cartContent">
        <!-- Cart items will be loaded dynamically -->
    </div>
</div>

<script>
    function loadCart() {
        const token = localStorage.getItem('token');
        
        if (!token) {
            document.getElementById('cartContent').innerHTML = `
                <div class="auth-required">
                    <h3>Please Login to View Your Cart</h3>
                    <p>You need to be logged in to view and manage your shopping cart.</p>
                    <div class="auth-actions">
                        <a href="/login" class="cta-button">Login</a>
                        <a href="/signup" class="cta-button secondary">Sign Up</a>
                    </div>
                </div>
            `;
            return;
        }

        fetch('/api/cart', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load cart');
            }
            return response.json();
        })
        .then(data => {
            const container = document.getElementById('cartContent');
            
            if (!data.items || data.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <h3>Your cart is empty</h3>
                        <p>Browse our products and add items to your cart.</p>
                        <a href="/products" class="cta-button">Start Shopping</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="cart-items">
                    ${data.items.map(item => `
                        <div class="cart-item">
                            <img src="${item.image}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/100x100?text=No+Image'">
                            <div class="item-details">
                                <h3><a href="/product/${item.id}">${item.name}</a></h3>
                                <p class="price">$${item.price} each</p>
                                <p class="category">${item.category}</p>
                            </div>
                            <div class="quantity-controls">
                                <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})" ${item.quantity >= item.stock ? 'disabled' : ''}>+</button>
                            </div>
                            <div class="item-total">
                                $${item.item_total}
                            </div>
                            <button class="remove-btn" onclick="updateQuantity(${item.id}, 0)">Remove</button>
                        </div>
                    `).join('')}
                </div>
                <div class="cart-summary">
                    <h3>Total: $${data.total}</h3>
                    <button class="checkout-btn" onclick="proceedToCheckout()">Proceed to Checkout</button>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('cartContent').innerHTML = `
                <div class="error-message">
                    <h3>Error Loading Cart</h3>
                    <p>There was a problem loading your cart. Please try again.</p>
                    <button onclick="loadCart()" class="cta-button">Retry</button>
                </div>
            `;
        });
    }

    function updateQuantity(productId, newQuantity) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Please login to manage your cart');
            window.location.href = '/login';
            return;
        }

        fetch('/api/cart/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({product_id: productId, quantity: newQuantity})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCart();
                updateCartCount();
            } else {
                alert('Error updating cart: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating cart');
        });
    }

    // function proceedToCheckout() {
    //     alert('Checkout functionality will be implemented in the next phase!');
    // }

    // Check authentication state on page load
    function checkAuthState() {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (token && user.id) {
            document.getElementById('authLinks').style.display = 'none';
            document.getElementById('userMenu').style.display = 'flex';
            document.getElementById('userName').textContent = user.first_name;
            
            if (user.user_type === 'admin') {
                document.getElementById('adminLink').style.display = 'inline-block';
            }
        } else {
            document.getElementById('authLinks').style.display = 'block';
            document.getElementById('userMenu').style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        checkAuthState();
        loadCart();
        
        // Add logout handler
        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                alert('Logged out successfully!');
                window.location.href = '/';
            });
        }
    });
</script>

{% endblock %}
